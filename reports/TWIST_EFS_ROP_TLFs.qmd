---
title: "TWIST-EFS - TLFs for ROP"
date: "2025-TBD"
format:
  docx:
    toc: true
    reference-doc: template.docx
  pdf:
    toc: true
  html:
    number-sections: true
    theme: cerulean
    highlight: kate
    toc: true
    toc-title: ""
    toc-float:
      collapsed: false
      smooth-scroll: true
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
 knitr::opts_chunk$set(echo = TRUE) 
library(knitr)
library(dplyr)
library(tibble)
library(flextable)
library(tinytex)
library(officer)
library(stringr)
library(lubridate)
library(ggplot2)
library(lubridate)
library(stringr)
library(showtext)
library(patchwork)

load("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS/data_archive/data_2025JUL28.RData")
source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_DSMB_2025NOV/programs/makedata/mk_adsl.R")
source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_DSMB_2025NOV/programs/makedata/mk_adsv.R")
source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_DSMB_2025NOV/programs/makedata/mk_adststat.R")
source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_DSMB_2025NOV/programs/makedata/mk_adecho.R")
source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_DSMB_2025NOV/programs/makedata/mk_adcec.R")

# get n for enrolled pop
n_enrolled <- nrow(subset(adsl, EnrolledFl == "Y"))

# get n for implanted pop
n_implanted <- nrow(subset(adsl, ImplantedFl == "Y"))
```
{{< pagebreak >}}

# Table 2 Patient Disposition & Follow-up Visit Compliance by Interval  
Enrolled Population (N=`r n_enrolled`)
```{r table2, message=FALSE, warning=FALSE}
#| echo: false
source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_DSMB_2025NOV/programs/TLFs/t2_patientdisposition.R")


t2_patientdisposition
```
{{< pagebreak >}}

# Table 3 Demographics and Baseline Characteristics  
Enrolled Population (N=`r n_enrolled`)
```{r table3, message=FALSE, warning=FALSE}
#| echo: false
source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_DSMB_2025NOV/programs/TLFs/t3_baselinedem.R")
  
  
t_baseline
```
{{< pagebreak >}}

# Table 8: CEC Adjudicated Endpoints for Events up to 1 Year  
Enrolled Population (N=`r n_enrolled`)
```{r table8, message=FALSE, warning=FALSE}
#| echo: false
source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_DSMB_2025NOV/programs/TLFs/t8_CEC_MAEs.R")
# Format flextable
t8 <- flextable(event_summary) %>%
  set_caption(caption = NULL) %>%
  set_header_labels(
    PARAM             = "Event",
    `<=30_NoEvents`   = "No. Events",
    `<=30_Patients`   = "Patients",
    `>30_NoEvents`    = "No. Events",
    `>30_Patients`    = "Patients",
    `Total_NoEvents`  = "No. Events",
    `Total_Patients`  = "Patients"
  ) %>%
  add_header_row(
    values = c(" ", "Early Events \n (\u2264 30 Days)", "Late Events \n (> 30 days to 1 Year)", "Total Events"),
    colwidths = c(1, 2, 2, 2)
  ) %>%
  autofit() %>%
  font(fontname = "Calibri", part = "all") %>%
  fontsize(size = 11, part = "all") %>%
  align(align = "center", part = "header") %>%
  align(j = 1, align = "left", part = "body") %>%
  align(j = 2:7, align = "center", part = "body") %>%
  bold(i = 1:2, part = "header") %>%
  bg(i = 1:2, bg = "#D3D3D3", part = "header") %>%
  border_remove() %>%
  border_outer(part = "all", border = fp_border(color = "black", width = 1)) %>%
  border(i = NULL, j = 1, border.right = fp_border(color = "black", width = 1)) %>%
  border(i = NULL, j = 3, border.right = fp_border(color = "black", width = 1)) %>%
  border(i = NULL, j = 5, border.right = fp_border(color = "black", width = 1)) %>%
  # âœ… Extend vertical lines into second header row
  border(i = 1:2, j = 1, part = "header", border.right = fp_border(color = "black", width = 1)) %>%
  border(i = 1:2, j = 3, part = "header", border.right = fp_border(color = "black", width = 1)) %>%
  border(i = 1:2, j = 5, part = "header", border.right = fp_border(color = "black", width = 1)) %>%
  border(i = 2,   j = 2:7, part = "header", border.top = fp_border(color = "black", width = 1)) %>%

  width(j = 1, width = 4.5) %>%
  width(j = 2, width = 0.7) %>%
  width(j = 3, width = 1.1) %>%
  width(j = 4, width = 0.7) %>%
  width(j = 5, width = 1.1) %>%
  width(j = 6, width = 0.7) %>%
  width(j = 7, width = 1.1) %>%
  add_footer_lines(paste0(
    "[1] Includes fatal, life-threatening, extensive or major bleeding as defined by MVARC \n",
    "Categorical measures: n/N (%).\n",
    program_info
  )) %>%
  font(fontname = "Calibri", part = "footer") %>%
  fontsize(size = 11, part = "footer") %>%
  padding(part = "footer", padding.top = 1, padding.bottom = 1) %>%
  border_outer(part = "footer") %>%
  fix_border_issues()

t8

```
{{< pagebreak >}}


# Table 11 CEC Adjudicated Heart Failure Hospitalizations and Non-elective Mitral Valve Reinterventions  
Enrolled Population (N=`r n_enrolled`)
```{r table11, message=FALSE, warning=FALSE}
#| echo: false
#source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_2025_11_DSMB/programs/makedata/mk_adsl.R")
source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_DSMB_2025NOV/programs/TLFs/t11_CEC_HFH_MVR.R")

tab <- 
  flextable(allresults) %>%
  set_caption(caption = NULL) %>%
  set_header_labels(
    Category = "",
    E_NEvents="No. Events", 
    E_Patients="Patients",
    L_NEvents="No. Events", 
    L_Patients="Patients",
    T_NEvents="No. Events", 
    T_Patients="Patients"
  ) %>%
  add_header_row(
    top = TRUE,
    values = c("Category", "Early Events \n (\u2264 30 Days)", 
               "Late Events \n (\u003E 30 Days to 1 Year)", "Total Events"),
    colwidths = c(1, 2, 2, 2) # Example: 1 column for "Main Header", 1 for "Sub Header 1", 1 for "Sub Header 2"
  ) %>%
  autofit() %>%
  font(fontname = "Calibri", part = "all") %>%
  fontsize(size = 11, part = "all") %>%
  align(align = "center", part = "body") %>%
  align(i=1:2, j=1, align = "left", part = "body") %>%
  align(i=1:2, align = "center", part = "header") %>%
  bold(i = 1:2, part = "header") %>%
  bg(i = 1:2, bg = "#D3D3D3", part = "header") %>%
  border(part = "all", border = officer::fp_border(color = "grey70", width = 1)) %>%
  width(j = 1, width = 2) %>%    
  width(j = 2:7, width = 1) %>% 
  #width(j = 3:4, width = 2) %>%
  add_footer_lines(c(
    "Categorical measures (%)",
    program_info
  )) %>%
  font(fontname = "Calibri", part = "footer") %>% 
  fontsize(size = 11, part = "footer") %>%
  padding(part = "footer", padding.top = 1, padding.bottom = 1) %>% 
  border_outer(part = "footer") %>% 
  fix_border_issues()

tab <- merge_at(tab, i = 1:2, j = 1, part = "header")

tab
```


# Table 13 NYHA Class: Unpaired Analysis  
Implanted Population (N=`r n_implanted`)
```{r table13, message=FALSE, warning=FALSE}
#| echo: false
#source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_2025_11_DSMB/programs/makedata/mk_adsl.R")
source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_DSMB_2025NOV/programs/TLFs/t13_NYHA.R")

tab <- 
  flextable(allresults) %>%
  set_caption(caption = NULL) %>%
  set_header_labels(
    Category = "",
    NYHAClass="NYHA Class", 
    Baseline=paste0("Baseline \n (N=", totaln_implanted, ")"),
    res30D=paste0("30 Days \n (N=", denom30, ")"), 
    res6M=paste0("6 Months \n (N=", denom6M, ")"),
    res1Y=paste0("1 Year \n (N=", denom1Y, ")")) %>%
  autofit() %>%
  font(fontname = "Calibri", part = "all") %>%
  fontsize(size = 11, part = "all") %>%
  align(align = "center", part = "body") %>%
  align(i=1:4, j=1, align = "left", part = "body") %>%
  align(i=1, j=2:5, align = "center", part = "header") %>%
  bold(i = 1, part = "header") %>%
  bg(i = 1, bg = "#D3D3D3", part = "header") %>%
  border(part = "all", border = officer::fp_border(color = "black", width = 0.5)) %>%
  # width(j = 1, width = 2) %>%    
  # width(j = 2:7, width = 1) %>% 
  #width(j = 3:4, width = 2) %>%
  add_footer_lines(c(
    "Categorical measures (%)",
    program_info
  )) %>%
    font(fontname = "Calibri", part = "footer") %>% 
    fontsize(size = 11, part = "footer") %>%
    padding(part = "footer", padding.top = 1, padding.bottom = 1) %>% 
    border_outer(part = "footer") %>% 
    fix_border_issues()


tab
```

# Table 14 MR Grade by Core Lab TTE: Unpaired Analysis
Implanted Population (N=`r n_implanted`)
```{r table14, message=FALSE, warning=FALSE}
#| echo: false
#source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_2025_11_DSMB/programs/makedata/mk_adsl.R")
source("C:/Users/luke_hall/OneDrive - Edwards Lifesciences/lhall/TWIST_EFS_DSMB_2025NOV/programs/TLFs/t14_MRgrade.R")

t14_MRgrade <- flextable(summary_df) %>%
  set_caption(caption = NULL) %>%
  set_header_labels(
    AVALC = "",  # First column label
    Discharge = paste0("Discharge \n (N=", denom_discharge, ")"),
    Baseline = paste0("Baseline \n (N=", denom_baseline, ")"),
    `30 Days` = paste0("30 Days \n (N=", denom_30D, ")"),
    `6 Months` = paste0("6 Months \n (N=", denom_6M, ")"),
    `1 Year` = paste0("1 Year \n (N=", denom_1Y, ")")
  ) %>%
  autofit() %>%
  font(fontname = "Calibri", part = "all") %>%
  fontsize(size = 11, part = "all") %>%
  align(align = "center", part = "body") %>%
  align(j = 1, align = "left", part = "body") %>%
  align(j = 2:6, align = "center", part = "header") %>%
  bold(i = 1, part = "header") %>%
  bg(i = 1, bg = "#D3D3D3", part = "header") %>%
  border(part = "all", border = fp_border(color = "black", width = 0.5)) %>%
  add_footer_lines(c(
    "Baseline column reports cumulative MR grade, while all other columns report transvalvular MR grade",
    "Categorical measures (%)",
    program_info
  )) %>%
  font(fontname = "Calibri", part = "footer") %>%
  fontsize(size = 11, part = "footer") %>%
  padding(part = "footer", padding.top = 1, padding.bottom = 1) %>%
  border_outer(part = "footer") %>%
  fix_border_issues()

t14_MRgrade
```
